---
title: Redis持久化RDB和AOF
date: 2016-05-09 14:48:19
tags: [Redis]
categories: Redis
---
Redis提供了两种不同级别的持久化方式
- RDB
- AOF

###### RDB、AOF概念
RDB持久化可以在指定的时间间隔内生成数据集的时间点快照。

AOF持久化记录服务器执行的所有写操作命令，在服务器启动时，通过执行这些命令来还原数据集。

###### RDB的优点
1. 紧凑易于备份，就一个文件
2. RDB可以最大化Redis性能，父进程无需做任何操作，只需fork一个子进程；
3. 恢复比AOF快

###### RDB的缺点
1. 数据完整性，如果非常注重数据的完整性，RDB就不行了，虽然是时间点的快照方式，但在快照过程中，Redis重启了，那么快照中的这些数据将会丢失。
2. 数据非常庞大后，非常耗CPU和时间，REDIS服务可能DOWN掉1秒甚至更长；

###### AOF的优点
1. AOF持久化让Redis变得更加耐久，AOF默认每一秒追加一次，也可以修改它的方式每执行一次追加一次，所以你最多丢失1秒钟的数据；
2. AOF文件是一个只进行追加操作的日志文件;
3. Redis可以在AOF文件体积变得过大时，自动地在后台对AOF重写

###### AOF缺点
1. 对于相同的数据集来说，AOF文件的体积大于RDB文件的体积；
2. 根据所使用的fsync策略，AOF的速度可能会慢于RDB；

###### RDB持久化原理
当Redis需要保存dump.rdb文件时，服务器执行以下操作：
1. Redis调用fork(),同时拥有父进程和子进程；
2. 子进程将数据集写入到一个临时RDB文件中；
3. 当子进程完成对RDB文件的写入时，Redis用新RDB文件替换原来的RDB文件，并删除旧的RDB文件；
4. 这种方式使得Redis可以从写时复制机制中获益

##### AOF持久化原理
1. Redis执行fork()，现在同时拥有父进程和子进程；
2. 子进程开始将AOF文件的内容写入到临时文件。
3. 对于所有新执行的写入命令，父进程一边将他们累积到一个内存缓存中，一边将这些改动追加到现有AOF文件的末尾，这样即使在重写的中途发生宕机，现有AOF文件也是安全的
4. 当子进程完成重写工作时，它给父进程发送一个信号，父进程在接收到信号之后，将内存缓存中的所有数据追加到新的AOF文件的末尾。
5. 现在Redis原子地用新文件替换旧文件，之后所有命令都会追加到新的AOF文件

##### AOF重写
- AOF的运作方式是不断将命令追加到文件的末尾，所以随着写入命令的不断增加，AOF文件的体积也变得越来越大。举个例子，如果你对计数器调用100次INCR，那么仅仅是为了保存这个计数器的当前值，AOF文件就需要使用100条记录，然而实际上只需一条SET命令就可以保存当前值；为了处理这种情况Redis会对AOF文件进行重写，执行beginWriteAof命令，Redis将生成一个新的AOF文件，这个文件将重建当前数据集所需的最少命令；

参考资料：
[Redis-cluster集群【第二篇】：redis持久化](http://www.cnblogs.com/luotianshuai/p/4969379.html)