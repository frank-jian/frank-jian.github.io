<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta name="baidu-site-verification" content="Y1BuCj8QZI" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="每天进步一点">
<meta property="og:type" content="website">
<meta property="og:title" content="记录点滴成长">
<meta property="og:url" content="http://jianwl.com/index.html">
<meta property="og:site_name" content="记录点滴成长">
<meta property="og:description" content="每天进步一点">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记录点滴成长">
<meta name="twitter:description" content="每天进步一点">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://jianwl.com/"/>

  <title> 记录点滴成长 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">记录点滴成长</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            书单
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/test/" itemprop="url">
                  test
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-13T10:46:03+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/test/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/test/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/13/MYSQL之时间运算/" itemprop="url">
                  MYSQL之时间运算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-13T10:36:09+08:00" content="2016-10-13">
              2016-10-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/13/MYSQL之时间运算/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/13/MYSQL之时间运算/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/10/Java之垃圾回收器/" itemprop="url">
                  Java之垃圾回收器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-10T22:54:36+08:00" content="2016-10-10">
              2016-10-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/10/Java之垃圾回收器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/10/Java之垃圾回收器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>内存的动态分配与内存回收技术已相当成熟，那为什么我们还要去了解GC和内存分配呢？答案很简单，当需要排查各种内存溢出、内存泄露问题时，当垃圾收集成为系统达到更高并发量的瓶颈时，我们需要对这些“自动化”的技术实施必要的监控和调节。</p>
<h3 id="垃圾回收器理论知识"><a href="#垃圾回收器理论知识" class="headerlink" title="垃圾回收器理论知识"></a>垃圾回收器理论知识</h3><p>要完成GC需要考虑以下三件事情：1.哪些内存需要回收？2.什么时候回收？3.如何回收？接下来会一一解答这些问题。</p>
<p><strong>哪些内存需要回收</strong></p>
<p>Java内存运行时，程序计数器、虚拟栈、本地方法栈这3个区域随线程生，随线程灭，每一个栈帧中分配多少内存基本上是在类结构确定下来时就已知了，因此这几个区域的内存分配和回收都具备确定性，不需要过多考虑回收的问题，因为方法或线程结束了，内存自然就回收了。</p>
<p>而Java堆和方法区则不一样，一个方法中的多个分支需要的内存可能不一样，只有在运行期间时才知道会创建哪些对象，这部分内存的分配和回收都是动态的，是垃圾回收器关注的对象。</p>
<p><strong>什么时候回收</strong></p>
<p>没有被引用的对象将被GC回收。</p>
<p><strong>如何回收</strong></p>
<p><code>引用计数算法</code>：给对象添加一个引用计数器，每当一个地方引用它，计数器值就加1，当引用失效时，计数器值就减1，任何时刻计数器为0的对象就不可能再被使用了。</p>
<p>很多人都认为GC是这种回收策略，但实际上主流的Java虚拟机都没有使用<code>引用计数算法</code>，因为它难以解决循环引用的问题。</p>
<p>举个例子：对象A和对象B都有instance字段，<code>A.instance = B，B.instance = A</code>,这两个对象互相引用对方，导致他们的引用计数都不为0，如果GC使用引用计数算法，那么他们不会被回收。但实际呢？让我们来实践一下。</p>
<p><code>ReferenceCountingGC.java</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// VM args: -XX:+PrintGCDetails 用于输出GC的详细日志 </div><div class="line">public class ReferenceCountingGC &#123;</div><div class="line"></div><div class="line">    public Object instance = null;</div><div class="line">    private static final int _1MB = 1024 * 1024 ;</div><div class="line"></div><div class="line">    // 这个成员的唯一意义就是占点内存,以便能在GC日志中看清楚是否被回收过</div><div class="line">    private byte[] bigSize = new byte[2 * _1MB];</div><div class="line"></div><div class="line">    public static void testGC()&#123;</div><div class="line">        ReferenceCountingGC objA = new ReferenceCountingGC();</div><div class="line">        ReferenceCountingGC objB = new ReferenceCountingGC();</div><div class="line">        objA.instance = objB;</div><div class="line">        objB.instance = objA;</div><div class="line"></div><div class="line">        objA = null;</div><div class="line">        objB = null;</div><div class="line"></div><div class="line">        System.gc();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        testGC();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果：</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-10/83029188.jpg" alt=""></p>
<p><code>分析：</code></p>
<p>GC日志中包含<code>6758K -&gt; 496K</code>意味着虚拟机并没有因为对象互相引用就不回收他们，侧面说明虚拟机并不是通过引用算法来判断的。那虚拟机是中什么算法来回收的呢？</p>
<p><code>可达性分析算法</code></p>
<p>主流的Java虚拟机是用可达性分析来判断对象是否可回收的。基本思想是通过一系列<code>GC Roots</code>的对象作为起始点，从这些节点向下搜索，搜索所走过的路径称为引用链。当一个对象到<code>GC Roots</code>没有任何引用链条相连，代表此对象可回收。</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-10/72297953.jpg" alt=""></p>
<p>可作为<code>GC Roots对象</code>有：</p>
<ol>
<li>虚拟栈中引用对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>Native方法引用对象</li>
</ol>
<p><strong>引用</strong></p>
<p>在<code>JDK1.2</code>以前，一个对象只有引用和没有引用两种状态，<code>JDK1.2</code>之后，对引用概念进行扩充，将引用分为<code>强引用</code>、<code>软引用</code>、<code>弱引用</code>、<code>虚引用</code>4中，强度依次递减。</p>
<p><code>强引用</code>：类似于<code>Object a = new Object()</code>,只要强引用存在，垃圾回收器永远不会回收引用对象。</p>
<p><code>软引用</code>：描述一些有用，但并非必须的引用。在系统发生内存溢出异常之前，将会把这些对象回收，如果回收后还没有足够内存，才会抛出内存溢出异常。</p>
<p><code>弱引用</code>：描述非必需对象，弱引用关联对象只能生存到下一次垃圾收集器发生之前，当垃圾回收期工作时，无论当前内存是否足够，都会回收弱引用对象。</p>
<p><code>虚引用</code>：一个对象是否有虚引用，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。唯一的目的就是能够在这个对象被回收器回收时会收到系统通知。</p>
<p><code>引用实战</code></p>
<p>未完待续…</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li>深入理解Java虚拟机</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/09/Java之内存区域/" itemprop="url">
                  Java之内存区域
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-09T22:13:45+08:00" content="2016-10-09">
              2016-10-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/09/Java之内存区域/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/09/Java之内存区域/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>对于Java开发人员来说，由于在虚拟机自动内存管理机制的帮助下，不在需要为每一个<code>new</code>的对象去配对<code>free</code>代码，不容易出现内存泄露的问题，但一旦出现内存泄露方面的问题，如果不了解虚拟机是怎么使用内存的，那么排错误将会成为一项异常艰难的问题。接下来，让我们一起来学习虚拟机的内存分配。</p>
<h3 id="Java虚拟机运行时数据区"><a href="#Java虚拟机运行时数据区" class="headerlink" title="Java虚拟机运行时数据区"></a>Java虚拟机运行时数据区</h3><p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/69952506.jpg" alt=""></p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong>1、 堆内存溢出报OutOfMemoryError</strong></p>
<p>限制Java堆最小值<code>-Xms</code>和最大值<code>-Xmx</code>为20M，避免自动扩展。通过参数<code>-XX:+HeapDumpOnOutOfMemoryError</code>可以让虚拟机在出现内存溢出时<code>Dump</code>出当前的内存堆转储快照以便之后分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// VM Args: -Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError</div><div class="line">public class HeapOOM &#123;</div><div class="line">    static class OOMObject&#123;&#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        List&lt;OOMObject&gt; list = new ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        while (true)&#123;</div><div class="line">            list.add(new OOMObject());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果：</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/10597433.jpg" alt=""></p>
<p><strong>2、栈内存溢出报StackOverFlowError</strong></p>
<p><code>实验1：</code></p>
<p>使用<code>-Xss</code>参数减少栈内存容量，结果:抛出<code>StackOverflowError</code>异常，异常出现时输出堆栈深度相应缩小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">// VM Args: -Xss160k</div><div class="line">public class JavaVMStackSOF &#123;</div><div class="line">    private int stackLength = 1;</div><div class="line"></div><div class="line">    public void stackLeak()&#123;</div><div class="line">        stackLength ++;</div><div class="line">        stackLeak();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        JavaVMStackSOF oom = new JavaVMStackSOF();</div><div class="line">        try&#123;</div><div class="line">            oom.stackLeak();</div><div class="line">        &#125;catch (Throwable e)&#123;</div><div class="line">            System.out.println(&quot;stack length : &quot; + oom.stackLength);</div><div class="line">            throw e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果：</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/62380876.jpg" alt=""></p>
<p><code>实验2：</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// VM args: -Xss4096M(不妨设大些)</div><div class="line">public class JavaVMStackOOM &#123;</div><div class="line">    private void dontStop()&#123;</div><div class="line">        while (true)&#123;&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void stackLeakByThread()&#123;</div><div class="line">        while (true)&#123;</div><div class="line">            Thread thread = new Thread(() -&gt; dontStop());</div><div class="line">            thread.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Throwable&#123;</div><div class="line">        JavaVMStackOOM oom = new JavaVMStackOOM();</div><div class="line">        oom.stackLeakByThread();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果:</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/93987125.jpg" alt=""></p>
<p><code>分析:</code><br>栈分配的内存越大，越容易出现内存溢出,其原因不难理解，操作系统分配给每个进程的内存是有限制的，譬如32的Windows限制为2GB，虚拟机提供参数来控制<code>JAVA</code>堆和方法区这两部分的最大内存。 <strong>剩余内存2G -&gt; 减去最大堆内存(Xmx) -&gt; 减去最大方法区容量(MaxPermSize) -&gt; 程序计数器消耗内存很小忽略 -&gt; 剩下就是虚拟栈和本地方法栈。</strong>栈越大，建立线程时越容易把剩下的内存耗尽。</p>
<p><strong>3、方法区和运行时常量池溢出</strong></p>
<p>String.intern()是一个Native方法，他的作用是如果字符串常量池中包含一个等于此String对象的字符串，则返回池中这个字符串的String对象，否则对象包含的字符串添加到常量池中，并返回String对象的引用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// JDK1.7前有效，到JDK1.8已移除永久代 </div><div class="line">// VM args: -XX:PermSize=10M -XX:MaxPermSize=10M</div><div class="line">public class RuntimeConstantPoolOOM &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // 使用List保持着常量池引用,避免FULL GC回收常量池行为</div><div class="line">        List&lt;String&gt; list = new ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        // 10MB的PermSize在interger范围内足够产生OOM了</div><div class="line">        int i = 0;</div><div class="line">        while(true)&#123;</div><div class="line">            list.add(String.valueOf(i++).intern());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果：</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/63281885.jpg" alt=""></p>
<p><strong>4、直接内存溢出(DirectOutOfMemory)</strong></p>
<p><code>DirectMemory</code>容量可通过<code>-XX:MaxDirectMemorySize</code>指定，如果不指定，则默认与Java堆最大值一样。以下代码通过反射获取Unsafe实例进行内存分配，抛出异常时并没有真正向操作系统申请分配内存，而是通过计算得知内存无法分配，于是手动抛出异常，真正申请分配内存的方法是<code>unsafe.allocateMemory()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// VM args: -Xmx20M -XX:MaxDirectMemorySize=10M</div><div class="line">public class DirectMemoryOOM &#123;</div><div class="line">    private static final int _1MB = 1024 * 1024 * 1024;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line">        Field unsaftField = Unsafe.class.getDeclaredFields()[0];</div><div class="line">        unsaftField.setAccessible(true);</div><div class="line">        Unsafe unsafe = (Unsafe) unsaftField.get(null);</div><div class="line">        while (true)&#123;</div><div class="line">            unsafe.allocateMemory(_1MB);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>结果:</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-10/69040604.jpg" alt=""></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li>深入理解Java虚拟机 – 周志明</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/SpringCloud之服务注册与发现/" itemprop="url">
                  SpringCloud之服务注册与发现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-08T19:13:06+08:00" content="2016-10-08">
              2016-10-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index">
                    <span itemprop="name">SpringCloud</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/08/SpringCloud之服务注册与发现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/08/SpringCloud之服务注册与发现/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么要使用服务发现"><a href="#为什么要使用服务发现" class="headerlink" title="为什么要使用服务发现"></a>为什么要使用服务发现</h3><p>设想一下，我们的代码用<code>REST API</code>和<code>Thrift API</code>来调用服务，为了完成一次请求，代码需要知道服务实例的网络位置(IP地址和端口)，传统应用都运行在物理硬件上，服务实例的网络位置都是相对固定的，例如，代码可以从一个经常变更的配置文件中读取网络位置。</p>
<p>而对于一个现代的，基于微服务的应用来说，这却是一个麻烦的问题，架构如图所示。</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/1336276.jpg" alt=""></p>
<p>服务实例的网络位置都是动态分配的，而且因为扩展、失效和升级需求，服务实例会经常动态改变，因为，客户端代码需要使用一种更加复杂的服务发现机制。</p>
<p>目前有两大类服务发现模式：<a href="http://microservices.io/patterns/client-side-discovery.html?utm_source=service-discovery-in-a-microservices-architecture&amp;utm_medium=blog" target="_blank" rel="external">客户端发现</a>和<a href="http://microservices.io/patterns/server-side-discovery.html?utm_source=service-discovery-in-a-microservices-architecture&amp;utm_medium=blog" target="_blank" rel="external">服务端发现</a></p>
<h3 id="客户端发现模式"><a href="#客户端发现模式" class="headerlink" title="客户端发现模式"></a>客户端发现模式</h3><p>当使用客户端发现模式时，客户端负责决定相应的服务实例的网络位置，并且对请求实现负责均衡。客户端从一个注册服务中查询，其中是所有可用服务实例的库,客户端使用负载均衡算法从多个服务实例中选择出一个，然后发出请求。架构如图所示：</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/13733713.jpg" alt=""></p>
<p>服务实例的网络位置是在启动时注册到服务注册表中，并且服务终止时从注册表中删除，服务实例注册信息一般使用心跳机制来定期刷新。</p>
<p><a href="https://netflix.github.io/" target="_blank" rel="external">Netflix OSS</a>提供了一种非常棒的客户端发现模式，<a href="https://github.com/Netflix/eureka" target="_blank" rel="external">Netflix Eureka</a>是一个注册服务表，为服务实例注册管理和查询可用实例，提供了REST API接口。<a href="https://github.com/Netflix/ribbon" target="_blank" rel="external">Netflix Ribbon</a>是一种IPC客户端，与Eureka合同工作实现对请求的负载均衡。</p>
<p><code>优点</code></p>
<p>除了服务注册表，没有其他改变的因素，客户端知道可用服务注册表信息，因此客户端可以使用哈希一直性变得更加聪明，更加有效的负载均衡。</p>
<p><code>缺点</code></p>
<p>需要针对不同的编程语言注册不同的服务，在客户端需要为每种语言开发不同的服务。</p>
<h3 id="服务端发现模式"><a href="#服务端发现模式" class="headerlink" title="服务端发现模式"></a>服务端发现模式</h3><p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/19412124.jpg" alt=""></p>
<p>客户端通过负载均衡器向各某个服务器提出请求，负载均衡器向服务注册表发出请求，将每个请求转发往可用的服务实例，跟客户端发现一样，服务实例在服务注册表中注册或注销。</p>
<p>AWS Elastic Load Balancer(ELB)是一种服务端发现路由的例子，ELB一般用于均衡从网络来的访问流量，也可以使用ELB来均衡VPC内部的流量，客户端使用DNS，通过ELB发出请求(HTTP或者TCP)，ELB负载均衡器负载在注册的EC2实例或者ECS容器之间均衡负载，并不存在一个分离的注册表，而EC2实例和ECS实例也想ELB注册。</p>
<p>HTTP服务和类似NGNIX和<a href="https://www.nginx.com/products/" target="_blank" rel="external">NGINX Plus</a>的负载均衡器都可以作为服务端发现均衡器，例如，<a href="https://www.airpair.com/scalable-architecture-with-docker-consul-and-nginx" target="_blank" rel="external">这篇博文</a>就描述如何使用<a href="https://github.com/hashicorp/consul-template" target="_blank" rel="external">Consul Template</a>来动态配置NGNIX反向代理。Consul Template是周期性从存放在Consul Template注册表中配合数据重建配置文件的工具。当文件发生变化时，会运行一个命令，在如何博客中，Consul Template产生了一个nginx.conf文件，用于配置反向代理，然后运行一个命令，告诉NGINX重新调入配置文件，更复杂的例子可以用HTTP API或者DNS动态重新配置NGINX Plus.</p>
<p>某些部署环境，例如<a href="https://github.com/kubernetes/kubernetes/blob/master/docs/design/architecture.md" target="_blank" rel="external">Kubernetes</a>和<a href="https://mesosphere.github.io/marathon/docs/service-discovery-load-balancing.html" target="_blank" rel="external">Marathon</a>在集群每个节点上运行一个代理，此代理作为服务端发现负载均衡器，为了向服务发出请求，客户端使用主机IP和分配的端口通过代理请求路由发出去，代理将次请求透明的转发到集群中可用的服务实例。</p>
<p><code>优点</code></p>
<p>客户端无需关注发现的细节，客户端只需简单的向负载均衡器发送请求，实际上减少了编程语言框架需要完成的发现逻辑。</p>
<p><code>缺点</code></p>
<p>除非部署环境提供负载均衡器，否则负载均衡器是另一个需要配置管理的高可用系统功能。</p>
<h3 id="服务注册表"><a href="#服务注册表" class="headerlink" title="服务注册表"></a>服务注册表</h3><p><a href="http://microservices.io/patterns/service-registry.html" target="_blank" rel="external">服务注册表</a>是服务发现很重要的部分，它是包含服务实例网络地址的数据库，服务注册表需要高可用而且随时更新，客户端可以缓存从服务注册表获得的网络地址，然而，这些信息最终会变得过时，客户端也无法服务实例。因此，服务注册表由若干使用复制协议保持同步的服务器构成。</p>
<p>如前所述，<a href="https://github.com/Netflix/eureka" target="_blank" rel="external">Netflix Eureka</a>是一个服务注册表很好地例子，提供了REST API注册和请求服务实例，服务实例使用POST请求注册网络地址，每30秒必须使用PUT方法更新注册表，使用HTTP DELETE请求或者实例超时来注销。客户端可以使用HTTP GET请求接受注册服务实例信息。</p>
<p>Netflix通过在每个AWS EC2域运行一个或者多个Eureka服务实现高可用性，每个Eureka服务器都运行在拥有弹性IP地址的EC2实例上，DNS TEXT记录用于存储Eureka集群配置，其中存放从可用域到一系列Eureka服务器网络地址的列表。当Eureka服务启动时，向DNS请求接受Eureka集群配置，确认同伴位置，给自己分配一个未被使用的弹性IP地址。</p>
<p>Eureka客户端 —&gt; 服务和服务客户端 —&gt; 向DNS请求发现Eureka服务的网络地址，客户端首选使用同一域内的服务。然而，如果没有可用服务，客户端会使用另外一个可用域的Eureka服务。</p>
<p>另外一些服务注册表例子包括：</p>
<ul>
<li><a href="https://github.com/coreos/etcd" target="_blank" rel="external">etcd</a> – 是一个高可用，分布式的，一致性的，键值表，用于共享配置和服务发现。两个著名案例包括Kubernetes和Cloud Foundry。</li>
<li><a href="https://www.consul.io/" target="_blank" rel="external">consul</a> – 是一个用于发现和配置的服务。提供了一个API允许客户端注册和发现服务。Consul可以用于健康检查来判断服务可用性。</li>
<li><a href="http://zookeeper.apache.org/" target="_blank" rel="external">Apache ZooKeeper</a> – 是一个广泛使用，为分布式应用提供高性能整合的服务。Apache ZooKeeper最初是Hadoop的子项目，现在已经变成顶级项目。</li>
</ul>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong>注册服务中心</strong></p>
<p>创建一个SpringBoot工程，并在<code>pom.xml</code>中引入需要依赖的内容</p>
<p><code>pom.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line"></div><div class="line">    &lt;groupId&gt;com.dada&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;springclouddemo&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</div><div class="line"></div><div class="line">    &lt;name&gt;SpringCloudDemo&lt;/name&gt;</div><div class="line">    &lt;description&gt;SpringCloudDemo&lt;/description&gt;</div><div class="line"></div><div class="line">    &lt;parent&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;1.4.1.RELEASE&lt;/version&gt;</div><div class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</div><div class="line">    &lt;/parent&gt;</div><div class="line"></div><div class="line">    &lt;properties&gt;</div><div class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</div><div class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</div><div class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</div><div class="line">    &lt;/properties&gt;</div><div class="line"></div><div class="line">    &lt;dependencies&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div class="line">            &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">        &lt;dependency&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</div><div class="line">        &lt;/dependency&gt;</div><div class="line">    &lt;/dependencies&gt;</div><div class="line"></div><div class="line">    &lt;dependencyManagement&gt;</div><div class="line">        &lt;dependencies&gt;</div><div class="line">            &lt;dependency&gt;</div><div class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;Brixton.RELEASE&lt;/version&gt;</div><div class="line">                &lt;type&gt;pom&lt;/type&gt;</div><div class="line">                &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">            &lt;/dependency&gt;</div><div class="line">        &lt;/dependencies&gt;</div><div class="line">    &lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">    &lt;build&gt;</div><div class="line">        &lt;plugins&gt;</div><div class="line">            &lt;plugin&gt;</div><div class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">            &lt;/plugin&gt;</div><div class="line">        &lt;/plugins&gt;</div><div class="line">    &lt;/build&gt;</div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
<p><code>@EnableEurekaServer</code>注解启动一个服务注册中心提供给其他应用进行对话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableEurekaServer</div><div class="line">public class SpringCloudDemoApplication &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		new SpringApplicationBuilder(SpringCloudDemoApplication.class).web(true).run(args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在默认配置下，该服务注册中心也会将自己作为客户端来尝试注册它自己，所以我们需要禁用他的客户端注册行为。</p>
<p><code>application.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server.port=1111</div><div class="line">eureka.client.register-with-eureka=false</div><div class="line">eureka.client.fetch-registry=false</div><div class="line">eureka.client.serviceUrl.defaultZone=http://localhost:$&#123;server.port&#125;/eureka/</div></pre></td></tr></table></figure>
<p>启动工程后，访问：<code>http:localhost:1111</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/4076123.jpg" alt=""></p>
<p><a href="http://git.oschina.net/shuangziliuyun/SpringBoot-Learning/tree/master/SpringCloudDemo?dir=1&amp;filepath=SpringCloudDemo&amp;oid=7ea641a1decaf22920670bfb29e9e198b701def7&amp;sha=66fe516db609fdcb2d95a59d2930d970c2c1be82" target="_blank" rel="external">SpringCloudDemo项目链接</a></p>
<p><strong>创建服务提供方</strong></p>
<p><code>场景：</code> 假设我们有一个提供计算功能的微服务模块，我们实现一个RESTFUL API，通过传入两个参数<code>valueA</code>和<code>valueB</code>的微服务模块，我们实现一个RESTFUL API，通过传入两个参数<code>valueA</code>和<code>valueB</code>,最后返回<code>valueA + valueB</code>的结果。</p>
<p><code>pom.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div class="line"></div><div class="line">	&lt;groupId&gt;com.dada&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;computeservice&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</div><div class="line"></div><div class="line">	&lt;name&gt;ComputeService&lt;/name&gt;</div><div class="line">	&lt;description&gt;ComputeService&lt;/description&gt;</div><div class="line"></div><div class="line">	&lt;parent&gt;</div><div class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div class="line">		&lt;version&gt;1.4.1.RELEASE&lt;/version&gt;</div><div class="line">		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</div><div class="line">	&lt;/parent&gt;</div><div class="line"></div><div class="line">	&lt;properties&gt;</div><div class="line">		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</div><div class="line">		&lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</div><div class="line">		&lt;java.version&gt;1.8&lt;/java.version&gt;</div><div class="line">	&lt;/properties&gt;</div><div class="line"></div><div class="line">	&lt;dependencies&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div class="line">			&lt;scope&gt;test&lt;/scope&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">		&lt;dependency&gt;</div><div class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">			&lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</div><div class="line">		&lt;/dependency&gt;</div><div class="line">	&lt;/dependencies&gt;</div><div class="line"></div><div class="line">	&lt;dependencyManagement&gt;</div><div class="line">		&lt;dependencies&gt;</div><div class="line">			&lt;dependency&gt;</div><div class="line">				&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">				&lt;version&gt;Brixton.RELEASE&lt;/version&gt;</div><div class="line">				&lt;type&gt;pom&lt;/type&gt;</div><div class="line">				&lt;scope&gt;import&lt;/scope&gt;</div><div class="line">			&lt;/dependency&gt;</div><div class="line">		&lt;/dependencies&gt;</div><div class="line">	&lt;/dependencyManagement&gt;</div><div class="line"></div><div class="line">	&lt;build&gt;</div><div class="line">		&lt;plugins&gt;</div><div class="line">			&lt;plugin&gt;</div><div class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">			&lt;/plugin&gt;</div><div class="line">		&lt;/plugins&gt;</div><div class="line">	&lt;/build&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;/project&gt;</div></pre></td></tr></table></figure>
<p>实现<code>/add</code>请求处理接口，通过<code>DiscoveryClient</code>对象，在日志中打印出服务实例的相关内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class ComputeController &#123;</div><div class="line">    private static final Logger logger = LoggerFactory.getLogger(ComputeController.class);</div><div class="line"></div><div class="line">    @Autowired</div><div class="line">    private DiscoveryClient client;</div><div class="line"></div><div class="line">    @RequestMapping(value = &quot;/add&quot;,method = RequestMethod.GET)</div><div class="line">    public Integer add(@RequestParam Integer valueA,@RequestParam Integer valueB)&#123;</div><div class="line">        ServiceInstance instance = client.getLocalServiceInstance();</div><div class="line">        Integer result = valueA + valueB;</div><div class="line">        logger.info(&quot;/add, host: &quot; + instance.getHost() + &quot; service_id : &quot; + instance.getServiceId() + &quot;, result: &quot; + result);</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在主类中加上<code>@EnableDiscoveryClient</code>注解，该注解能激活Eureka中的<code>DiscoveryClient</code>实现，才能实现Controller中对服务信息的输出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">@EnableDiscoveryClient</div><div class="line">public class ComputeServiceApplication &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		new SpringApplicationBuilder(ComputeServiceApplication.class).web(true).run(args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>application.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 指定微服务名称后续在调用只需使用名称就可以进行服务访问了</div><div class="line">spring.application.name=compute-service</div><div class="line"></div><div class="line"># 为了在本机上测试区分服务提供方和服务注册中心，设置端口。</div><div class="line">server.port=2222</div><div class="line"></div><div class="line"># 服务注册中心的位置</div><div class="line">eureka.client.serviceUrl.defaultZone=http://localhost:1111/eureka/</div></pre></td></tr></table></figure>
<p>启动工程后，再次访问：<code>http:localhost:1111/</code></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-10-9/98601009.jpg" alt=""></p>
<p>可以看到，我们定义的服务被注册了。</p>
<p><a href="http://git.oschina.net/shuangziliuyun/SpringBoot-Learning/tree/master/ComputeService?dir=1&amp;filepath=ComputeService&amp;oid=8233018cf6b98106be981444bb5fe1ecf7d73630&amp;sha=66fe516db609fdcb2d95a59d2930d970c2c1be82" target="_blank" rel="external">ComputeService项目链接</a></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/?utm_source=deploying-microservices&amp;utm_medium=blog" target="_blank" rel="external">Service Discovery in a Microservices Architecture </a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/29/规划好技术路线，如何将想法落地？/" itemprop="url">
                  规划好技术路线，如何将想法落地?
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-29T15:02:56+08:00" content="2016-09-29">
              2016-09-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/思绪/" itemprop="url" rel="index">
                    <span itemprop="name">思绪</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/29/规划好技术路线，如何将想法落地？/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/29/规划好技术路线，如何将想法落地？/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>作为一个工程师，多多少少都有自己的技术路线的规划，怎么这些规划落地，真正地去磨练技术，这是个值得思考的问题？本文介绍一个方法<code>三段分解法</code>，即：<code>将一个宏大或者长远的目标经过三次分解，得到一个个短期内能够达到的小目标。</code></p>
<p><code>Tips</code>: 以下内容引用于<code>阿里巴巴李运华</code>。</p>
<h3 id="正确的做法"><a href="#正确的做法" class="headerlink" title="正确的做法"></a>正确的做法</h3><p><strong>一段分解：瞄准目标</strong></p>
<p>我想10年成为大牛，这个目标虽然比较长远比较宏大，但并不意味着，我们在没有没有成为大牛之前，都是菜鸟。从菜鸟到大牛的过程中，中间其实有几个关键的里程碑，这些里程碑就是我们的一段目标。</p>
<p>以技术人员为例，技术人员典型的发展路径基本上都是下面的这个模式：</p>
<p>1）0 ~ 1年：菜鸟，需要别人手把手来教</p>
<p>2）1 ~ 3年：初级，需要别人带你做</p>
<p>3）3 ~ 5年：高级，能独当一面，可以带初级技术人员了</p>
<p>4）5 ~ 8年：资深，能独挡多面</p>
<p>5）8 ~ 10年：大牛，统筹规划，高屋建瓴</p>
<p>通过这种分解方法，再核对一下自己目前所处的位置，然后先瞄准下一个目标，全力以赴其实也就2 ~ 3年时间，这样来看一段目标其实是比较容易达成的。</p>
<p>这种目标分解的方法除了适合技术人员外，其它很多领域也都适应，比如说产品人员、运营人员、甚至公务员！</p>
<p><strong>二段分解：掌握技能</strong></p>
<p>经过一段分解后，明确自己目前所处的位置和下一个目标，接下来就要看这个一段目标如何实现了。虽然说每个一段目标持续时间在 2~3年，但3年时间说长不长，说短也不短，如果没有好好利用，可能到了2年多的时候回头一看，好像什么都没达成，还是原地踏步。因此，为了更好的利用这3年时间，我们需要进一步分解，这就是“二段分解”。</p>
<p>还是以技术人员为例，假设经过自我评估，认为自己目前处于初级阶段，而且初级阶段的事情已经做得比较顺手和熟练了，那么下一个一段目标自然就是达到“高级”水平。“高级”与“初级”相比，有哪些不同的技能要求呢？</p>
<p>这就需要我们根据各自不同的行业和方向详细列出来了，如果自己想不出来，网上有很多资料都可以搜索到，最方便的就是到一个招聘网站，多看看几个招聘需求的描述，然后归纳总结一下。</p>
<p>我们随便到网上搜索一个，例如达达的“高级Java开发工程师”招聘：</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-9-29/17450031.jpg" alt=""></p>
<p>多看几个类似的职位招聘，基本上我们就能明白“高级Java开发工程师”的一些基本要求。当然实际上的技能要求比招聘需求的描述还要更加细致，我个人的习惯是将这些要求整理为一个思维导图，详细列出每个技术点。例如：</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-9-29/45436716.jpg" alt=""></p>
<p>有了这样一个思维导图后，我们就可以开始真正进行二段分解了，分解的方法很简单：哪里不懂补哪里！例如：我感觉目前我的数据库水平一般，仅仅会写CRUD语句，其它的东西都不懂，那我就开始专攻数据库这一部分，经过一段时间的专攻来提升自己的水平。</p>
<p>二段目标持续时间一般建议是6个月，既不能太短也不能太长。太短容易让人陷入为了目标而做的误区，没有真正得到有效提升；时间太长的话，3年时间又不够完成其它目标了，例如要是我定一个目标说2年提升数据库，那操作系统怎么办？网络怎么办？……等等。以6个月为一个周期，基本上刚刚好。</p>
<p>经过分解，最终的二段目标可以分解为如下的几个更小的目标：</p>
<p>1）2016.06 ~ 2017.01：提升数据库水平</p>
<p>2）2017.01 ~ 2017.06：提升Linux水平</p>
<p>3）2017.06 ~ 2017.12：提升网络和网络编程水平</p>
<p>当然，二段分解目标并不是一成不变的，很多时候需要根据我们工作的内容进行调整。例如老大正好安排我来负责优化系统性能，降低机器负载，那么我完全可以将“提升Linux水平”安排到“提升数据库水平”之前。</p>
<p><strong>三段分解: 规划执行</strong></p>
<p>二段分解得到的小目标后，接下来关键就是要实现这个目标，这就是三段分解的主要目的，即，将技能目标分解为具体要做的事情，然后按计划执行。</p>
<p>比如说我的二段目标是“提升Linux水平”，那怎么样才能提升呢？可以上网搜索，也可以去问有经验的朋友。明确要做的事情后，三段分解需要将二段分解的6个月目标更加细化，分为1个月或者两个月一个目标。</p>
<p>以我当时加入UC的情况为例，我在华为的时候是在Windows平台上用VC6进行开发，而到了UC的时候是在Linux平台上用C++开发，我当时定了“提升Linux水平”的目标，然后通过上网查，找别人问等方法，最终将这个目标分解为几个步骤：</p>
<p>1）1个月：通读《UNIX环境高级编程》</p>
<p>2）1个月：通读《Linux系统编程》</p>
<p>3）2个月：通读《UNIX网络编程 卷1》</p>
<p>4）1个月：Linux常用命令实战：tcpdump、ps、top等</p>
<p>通过这种方法，将6个月的目标又进一步分解为1个月的目标，实施起来就简单多了，每1 ~ 2个月专注一个具体目标，每次完成后都很有成就感，既感觉自己的水平有了提升，又佩服自己能够坚持按计划按目标完成任务，双重奖赏让自己更有动力进行下一个目标。我大约花了2年的时间将Linux、网络、MySQL三个重点技能从一无所知提升到高级的水平，很多同事都问我之前在华为是不是就是做这方面的，因为他们觉得短时间能达到这个水平是不太可能的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>综合前面的分析，我们将三段分解提炼一下：一段分解“等级”，二段分解“技能”，三段分解“行动”。</p>
<p>Tips:<code>学习时，尽量获取第一手资料，往后你会发现这样做是多么的正确。</code></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650994070&amp;idx=1&amp;sn=7bd89e8d208b87a8c47b5b172cdc335d&amp;chksm=bdbf0dc58ac884d3de1640df97494ab50280dd350910445392c540ab7e7e4130d109b1d465d2&amp;scene=21#wechat_redirect" target="_blank" rel="external">技术人的小目标：10000小时理论落地，你就是大牛 – 阿里李运华</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/29/天天写「业务代码」，如何成为「技术大牛」/" itemprop="url">
                  天天写「业务代码」，如何成为「技术大牛」
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-29T09:46:27+08:00" content="2016-09-29">
              2016-09-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/思绪/" itemprop="url" rel="index">
                    <span itemprop="name">思绪</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/29/天天写「业务代码」，如何成为「技术大牛」/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/29/天天写「业务代码」，如何成为「技术大牛」/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>「一直写业务代码，能够成长为技术大牛？」这也是我一直困惑的地方，今早在地铁上看到<code>阿里李运华</code>的这篇文章，感悟良多，现阶段的我，思维存在一定的误区，内心有些浮躁，梳理文章要点, 规划修炼之路，并将文中所提及的方法付诸实践。</p>
<p><code>Tips</code>: 以下内容引用于<code>阿里巴巴李运华</code>。</p>
<h3 id="误区"><a href="#误区" class="headerlink" title="误区"></a>误区</h3><p><strong>拜大牛为师</strong></p>
<blockquote>
<p>知乎上有人认为想成为大牛最简单直接、快速有效的方式是拜团队技术大牛为师，让他们平时给你开小灶，给你分配一些有难度的工作。</p>
</blockquote>
<p>个人觉得这个方法不现实；</p>
<ol>
<li>大牛很忙，不太可能单独给你开小灶，更不可能每天都给你开一个小时的小灶。</li>
<li>因为第一个原因，所以一般找大牛，都是带着问题去请教或探讨。</li>
<li>大牛不多，不可能每个团队都有技术大牛，只能说团队里会有比你水平高的人，即使每天给你开小灶，最终你也只能提升到他的水平。</li>
</ol>
<p>综上所述的几个原因，对于大部分人来说，要想成为大牛，首先还是要明白“主要靠自己”。</p>
<p><strong>业务代码一样很牛逼</strong></p>
<blockquote>
<p>知乎上有人回答认为写业务代码一样可以很牛逼，理由是业务代码一样可以有各种技巧，日志记录好了问题，问题定位效率可以提升10倍…等等</p>
</blockquote>
<p>业务代码有技术含量这是肯定的，业务代码中的技术是每个程序员的基础，但只是掌握这些技巧，并不能成为技术大牛。就想游戏中升级打怪一样，开始打小怪，经验值很高，越到后面经验值越少，打小怪已经不能提升经验值了。这个时候就需要打一些更高级的怪，刷一些有挑战的副本了，没看到哪个游戏，只要一直打小怪就能升到顶级的。</p>
<p>成为技术大牛的路也类似，要不断提升自己的水平，然后面临更大的挑战，通过应对这些挑战从而使自己的水平更上一级。写业务代码只是打怪升级路上的一个挑战而已，而且是一个比较初级的挑战。</p>
<p>所以，业务代码都写不好的程序员肯定无法成为技术大牛，但只把业务代码写好的程序员也还不能成为技术大牛。</p>
<p><strong>上班太忙没时间自学</strong></p>
<blockquote>
<p>很多人认为自己没有成为技术大牛并不是自己不聪明，也不是自己不努力，而是中国的这个环境下，技术人员加班太多，导致自己没有额外的时间进行学习。</p>
</blockquote>
<p>有几个误区导致了这种想法</p>
<ol>
<li>上班做的都是重复工作，要想提升必须自己额外去学习</li>
<li>学习需要大段的连续时间，实际上做法正好相反，我们应该在工作中学习和提升，因为学以致用，或者有实例参考，学习的效果是最好的，其次工作后学习不需要打算时间，而是要挤出时间，利用时间碎片来学习。</li>
</ol>
<h3 id="正确的做法"><a href="#正确的做法" class="headerlink" title="正确的做法"></a>正确的做法</h3><p><strong>DO MORE</strong></p>
<p>1.<code>熟悉更多业务 &amp; 代码</code></p>
<p> 熟悉更多业务，不管是不是你负责的;熟悉更多代码，不管是不是你写的；</p>
<p> 2.<code>熟悉端到端</code></p>
<p> 比如说你负责后端web后台开发，但实际用户发起一个HTTP请求，要经过很多中间步骤才能到你的服务器(例如浏览器缓存、NDS、Nginx等)，但服务器一般又会经过很多处理才到你写的那部分代码(路由、权限等)这整个流程中的很多系统或者步骤，绝大部分人是不可能参与写代码的，但掌握这些知识对你的综合水平有很大的作用。</p>
<p>3.<code>自学</code></p>
<p>以<code>Java</code>为例，大部分业务代码就是<code>if-else</code>加个数据库操作，但我们完全可以自己学写更<code>java</code>的知识，例如垃圾回收、调优、网络编程等，这些可能暂时没用，但真要用的时候，不是Google一下就可以了，这个时候谁已经掌握了相关知识和技能，机会就是谁的。 </p>
<p>以垃圾回收为例，平时抽时间学习了这些知识，学了1年都没用上，但后来用上了几次，每次都解决了卡死的问题，而有的同学，写了几年的<code>java</code>代码，对于<code>stop-the-world</code>是什么概念都不知道，更不要说去优化了。</p>
<p>很多开源软件，更加需要自己平时去学，例如<code>Nignx、Redis、Mongodb、ElasticSearch等</code>在合适的时机引入这些技术，能够能够带来很大的价值。</p>
<p><strong>DO BETTER</strong></p>
<p>世界上没有完美的东西，你负责的系统和业务，总有不合理和可以改进的地方，这些不合理和可改进的地方，都是更高级别的怪物，打完后能够增加更多的经验值。识别出这些地方，并且给出解决方案。</p>
<p>例如：</p>
<ul>
<li>重复代码太多，是否可以引入设计模式？</li>
<li>系统系能一般，可否进行优化？</li>
<li>目前是单机，如果做成双机是否更好？</li>
<li>版本开发质量不高，是否引入高效的单元测试和集成测试方案？</li>
<li>目前的系统太庞大，是否可以通过重构和解耦改为3个系统？</li>
<li>阿里中间件有一些系统感觉我们也可以用，是否可以引入？</li>
</ul>
<p>只要你去想，其实总能发现可以改进得地方，如果你觉得系统哪里都没有改进的地方，那就说明你的水平还不够，可以多学习相关技术，多看看业界其他公司怎么做，BAT都怎么做。</p>
<p><strong>DO EXERCISE</strong></p>
<p>在执行过程中，发现确实做到了<code>DO MORE 、DO BETTER</code>,但光看不用效果很差，怎么办？</p>
<p>例如：</p>
<ul>
<li>学习了JVM的垃圾回收，但是线上比较少出现FGC导致的卡顿问题，就算出现了，恢复业务也是第一位的，不太可能线上出现问题然后让每个同学都去练一下手，那么怎么去实践这些JVM的只是和技能呢？</li>
<li>Netty我也看了，也了解了Reactor原理，但是我不可能参与Netty开发，怎么让自己真正掌握Reactor异步模式呢？</li>
<li>看了«高性能MySQL»，但是线上的数据库都是DBA管理的，测试环境的数据库感觉又是随便配置的，我怎么去验证这些技术呢？</li>
<li>框架封装了DAL层，数据库的访问我们都不需要操心，我们怎么去了解分库分表实现？</li>
</ul>
<p>诸如此类问题，总结下来就是三个词：<code>Learning</code>、<code>Trying</code>、<code>Teaching</code></p>
<p>1.<code>Learning</code></p>
<p>这是第一阶段，看书、Google、看视频、看别人的博客都可以，但要注意一点是<code>系统化</code>，特别是一些基础性的东西，例如JVM原理、Java编程、网络编程、HTTP协议等等，这些基础技术不能只通过Google或者博客学习，我的做法一般是先完整看完一本书全面的了解，然后在通过Google、视频、博客有针对性的查找一些有疑问的地方或者一些技巧。</p>
<p>2.<code>Trying</code></p>
<p><code>自己动手丰衣足食</code>，也就是自己去尝试搭建一些模拟环境，自己写一些测试程序。例如：</p>
<ul>
<li>JVM垃圾回收：可以自己写个简单的测试程序，分配内存不释放，然后调整各种JVM启动参数，在运行的过程使用Jstack、Jstat等命令查看JVM的堆内存分布和垃圾回收情况。</li>
<li>Reactor原理：自己真正尝试写一个Reactor模式的Demo，不要以为这个很难，简单的Reactor模式代码量不超过200行(可以参考Doug Lee的PPT)，自己写完后，再看看netty怎么做，一对比理解就更加深刻了。</li>
<li>MySQL:既然有线上的配置可以参考，那可以直接让DBA将线上配置发给我们，直接学习，然后搭建一个MySQL环境，用线上的配置启动；</li>
<li>框架封装了DAL层，可以自己用JDBC尝试去写一个分库分表的简单实现，然后与框架的实现进行对比，看看差异在哪里？</li>
<li>用浏览器的工具查看HTTP缓存实现，看看不同种类的网站、不同类型的资源，具体是如何控制缓存的，也可以自己用Python写一个简单的HTTP服务器，模拟返回各种HTTP Headers来观察浏览器的反应。</li>
</ul>
<p>真正想去实践，很多场景其实可以自己模拟，当然如果在实际工作中使用，效果会更好，毕竟线上的环境和业务服务度不是我们写个模拟程序就能够模拟的，但这样的机会可遇不可求，大部分情况，我们还真只能靠自己模拟，然后等到真正业务要用的时候，能够信手捏来。 </p>
<p>3.<code>Teaching</code></p>
<p>一般来说，经过Learning和Trying，能够掌握70%左右，但要到真正掌握，我觉得一定要做到能够跟别人讲清楚，因为在讲的时候，我们既需要将一个知识点系统化，也需要考虑各种细节，这会促使我们进一步思考和学习。同时，讲出来后看或听的人有不同的理解，或者有新的补充，相当于继续晚上整个知识技能体系。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650994277&amp;idx=1&amp;sn=f0d3c25d805503264a78ab5eeb29044d&amp;chksm=bdbf0e368ac88720da10e901457fdbee77a90a426c20a3b95316fcbc6c8ab7b1afbd55950ad3&amp;mpshare=1&amp;scene=1&amp;srcid=0929Z1bTPNoOJWSebrDHoiwl#rd" target="_blank" rel="external">天天写「业务代码」，如何成为「技术大牛」 – 李运华</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/25/多线程设计模式之保护性暂挂-Guarged-Suspension/" itemprop="url">
                  多线程设计模式之保护性暂挂(Guarged Suspension)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-25T22:15:02+08:00" content="2016-09-25">
              2016-09-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/25/多线程设计模式之保护性暂挂-Guarged-Suspension/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/25/多线程设计模式之保护性暂挂-Guarged-Suspension/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>多线程编程中，为了提高并发性，往往会将一个任务分解为不同的部分，将其交由不同的线程来执行。这些线程间互相协作时，仍然可能出现一个线程去等待另一个线程完成一定的操作，其自身才能继续运行的情形。好比，汽车行驶过程中油量不足时，司机只好到加油站等工作人员将油加满才能继续行驶。</p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong>场景</strong></p>
<p>多线程获取共享资源需要条件时，这时候就需要用到保护性暂挂模式了。常见的例子是客户端与服务端的通信，客户端会不断的发送请求给服务端，服务端会不停的接受请求，假设我们用队列去存储请求，那么服务端就不能再队列为空的时候去接受请求，<code>这个是存取的条件 -- 队列不能为空</code></p>
<p><strong>数据模型：<code>Request.Java</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class Request &#123;</div><div class="line">    private final String name;</div><div class="line"></div><div class="line">    public Request(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;[ Request &quot; + name + &quot; ]&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>用<code>LinkedList</code>来存放<code>Request</code>：<code>RequestQueue.java</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public class RequestQueue &#123;</div><div class="line">    private final LinkedList queue = new LinkedList();</div><div class="line"></div><div class="line">    public synchronized Request getRequest() &#123;</div><div class="line">        while (queue.size() &lt;= 0) &#123;</div><div class="line">            try &#123;</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot;: wait() begins, queue = &quot; + queue);</div><div class="line">                wait();</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot;: wait() ends, queue = &quot; + queue);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return (Request) queue.removeFirst();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public synchronized void putRequest(Request request) &#123;</div><div class="line">        queue.addLast(request);</div><div class="line">        System.out.println(Thread.currentThread().getName() + &quot;: notifyAll() begins, queue = &quot; + queue);</div><div class="line">        notifyAll();</div><div class="line">        System.out.println(Thread.currentThread().getName() + &quot;: notifyAll() ends, queue = &quot; + queue);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>客户端不断发出请求：<code>ClientThread.java</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public class ClientThread extends Thread &#123;</div><div class="line">    private Random random;</div><div class="line">    private RequestQueue requestQueue;</div><div class="line"></div><div class="line">    public ClientThread(RequestQueue requestQueue, String name, long seed) &#123;</div><div class="line">        super(name);</div><div class="line">        this.requestQueue = requestQueue;</div><div class="line">        this.random = new Random(seed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void run() &#123;</div><div class="line">        try &#123;</div><div class="line">            for (int i = 0; i &lt; 10000; i++) &#123;</div><div class="line">                Request request = new Request(&quot;No.&quot; + i);</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot; requests &quot; + request);</div><div class="line">                requestQueue.putRequest(request);</div><div class="line">                Thread.sleep(random.nextInt(1000));</div><div class="line">            &#125;</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>服务端检验队列是否为空，不为空才取，否则线程阻塞:<code>ServerThread.java</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class ServerThread extends Thread &#123;</div><div class="line">    private Random random;</div><div class="line">    private RequestQueue requestQueue;</div><div class="line"></div><div class="line">    public ServerThread(RequestQueue requestQueue, String name, long seed) &#123;</div><div class="line">        super(name);</div><div class="line">        this.requestQueue = requestQueue;</div><div class="line">        this.random = new Random(seed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void run() &#123;</div><div class="line">        try &#123;</div><div class="line">            for (int i = 0; i &lt; 10000; i++) &#123;</div><div class="line">                Request request = requestQueue.getRequest();</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot; handles &quot; + request);</div><div class="line">                Thread.sleep(random.nextInt(1000));</div><div class="line">            &#125;</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>主函数：Main.java</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // 启动执行器</div><div class="line">        RequestQueue requestQueue = new RequestQueue();</div><div class="line">        Thread alice = new ClientThread(requestQueue, &quot;Alice&quot;, 314159L);</div><div class="line">        Thread bobby = new ServerThread(requestQueue, &quot;Bobby&quot;, 265358L);</div><div class="line">        alice.start();</div><div class="line">        bobby.start();</div><div class="line">        try &#123;</div><div class="line">            // 等待约10s</div><div class="line">            Thread.sleep(10000);</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;***** calling interrupt *****&quot;);</div><div class="line">        // 呼叫interrupt方法</div><div class="line">        alice.interrupt();</div><div class="line">        bobby.interrupt();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li>Java多线程编程实战指南 – 黄文海</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/25/Java之不可变对象/" itemprop="url">
                  Java之不可变对象
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-25T14:45:03+08:00" content="2016-09-25">
              2016-09-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/25/Java之不可变对象/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/25/Java之不可变对象/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>多线程共享变量的情况下，为了保证数据一致性，往往需要对这些变量的访问进行加锁。而锁本身又会带来一些问题和开销。<code>Immutable Object</code>使得我们可以在不使用锁的情况下，既保证共享变量访问的线程安全，又能避免锁引入带来的问题和开销。</p>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ol>
<li><strong>被建模对象的状态变化不频繁</strong></li>
<li><strong>同时对一组相关的数据进行写操作，需要保证原子性</strong></li>
<li><strong>使用某个对象作为安全的HashMap的Key</strong>，一个对象作为<code>HashMap</code>的Key被放入<code>HashMap</code>之后，若该对象状态变化导致了其<code>Hash Code</code>的变化，则会导致后面再同样的对象作为<code>Key</code>去<code>get</code>的时候无法获取关联的值，但由于不可变对象的状态不变，因此其<code>Hash Code</code>也不变。</li>
</ol>
<h3 id="需要注意的问题"><a href="#需要注意的问题" class="headerlink" title="需要注意的问题"></a>需要注意的问题</h3><ol>
<li>被建模对象的状态变更频繁，此时不见得不能使用不可变对象，只是状态变更需要频繁创建不可变对象，增加JVM垃圾回收。</li>
<li>防御性赋值，如果不可变对象本身包含一些状态需要对外暴露，而相应的字段本身又是可变的。那么返回这些字段的方法，还是需要做防御性复制，以避免外部代码修改了其内部的状态。</li>
</ol>
<h3 id="如何让类不可变"><a href="#如何让类不可变" class="headerlink" title="如何让类不可变"></a>如何让类不可变</h3><blockquote>
<p><a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/imstrat.html" target="_blank" rel="external">JAVA文档，有关如何定义不可变类指南</a></p>
</blockquote>
<ol>
<li>不提供<code>setter</code>方法，setter方法用于修改属性和对象引用。这个原则阐述了在类定义的所有可变属性中，不提供setter方法，setter方法意味着你能够改变这个属性的状态，必须阻止提供setter方法。</li>
<li>所有的属性修饰添加<code>private</code>和<code>final</code>。这是另一种增加不可变的方式，属性声明为<code>private</code>为了在类之外不能够被访问到，final修饰符为了让你不能随便的改变他们。</li>
<li>不允许子类重写方法。最简单的方式声明类为final，final类不允许重写。</li>
<li>当属性中存在可变对象变量时，要特别留意。对象分为不可变和可变，当对象可变时，对可变对象的内容进行复制，并创建一个新对象赋值给它，这样保证可变对象的不可变。</li>
<li>定义一个private的构造方法，通过工厂方法构造对象。</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong>创建不可变类：ImmutableClass.class</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">package immutable;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">/**</div><div class="line">* Always remember that your instance variables will be either mutable or immutable.</div><div class="line">* Identify them and return new objects with copied content for all mutable objects.</div><div class="line">* Immutable variables can be returned safely without extra effort.</div><div class="line">* */</div><div class="line">public final class ImmutableClass</div><div class="line">&#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">    * Integer class is immutable as it does not provide any setter to change its content</div><div class="line">    * */</div><div class="line">    private final Integer immutableField1;</div><div class="line">    /**</div><div class="line">    * String class is immutable as it also does not provide setter to change its content</div><div class="line">    * */</div><div class="line">    private final String immutableField2;</div><div class="line">    /**</div><div class="line">    * Date class is mutable as it provide setters to change various date/time parts</div><div class="line">    * */</div><div class="line">    private final Date mutableField;</div><div class="line"></div><div class="line">    //Default private constructor will ensure no unplanned construction of class</div><div class="line">    private ImmutableClass(Integer fld1, String fld2, Date date)</div><div class="line">    &#123;</div><div class="line">        this.immutableField1 = fld1;</div><div class="line">        this.immutableField2 = fld2;</div><div class="line">        this.mutableField = new Date(date.getTime());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //Factory method to store object creation logic in single place</div><div class="line">    public static ImmutableClass createNewInstance(Integer fld1, String fld2, Date date)</div><div class="line">    &#123;</div><div class="line">        return new ImmutableClass(fld1, fld2, date);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //Provide no setter methods</div><div class="line"></div><div class="line">    /**</div><div class="line">    * Integer class is immutable so we can return the instance variable as it is</div><div class="line">    * */</div><div class="line">    public Integer getImmutableField1() &#123;</div><div class="line">        return immutableField1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">    * String class is also immutable so we can return the instance variable as it is</div><div class="line">    * */</div><div class="line">    public String getImmutableField2() &#123;</div><div class="line">        return immutableField2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">    * Date class is mutable so we need a little care here.</div><div class="line">    * We should not return the reference of original instance variable.</div><div class="line">    * Instead a new Date object, with content copied to it, should be returned.</div><div class="line">    * */</div><div class="line">    public Date getMutableField() &#123;</div><div class="line">        return new Date(mutableField.getTime());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        return immutableField1 +&quot; - &quot;+ immutableField2 +&quot; - &quot;+ mutableField;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>验证以上为不可变类：MainTest.class</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">public class MainTest &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        ImmutableClass im = ImmutableClass.createNewInstance(100, &quot;test&quot;, new Date());</div><div class="line">        System.out.println(im);</div><div class="line">        tryModification(im.getImmutableField1(), im.getImmutableField2(), im.getMutableField());</div><div class="line">        System.out.println(im);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void tryModification(Integer immutableField1, String immutableField2, Date mutableField) &#123;</div><div class="line">        immutableField1 = 10000;</div><div class="line">        immutableField2 = &quot;test changed&quot;;</div><div class="line">        mutableField.setDate(10);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>执行结果</strong></p>
<p>不可变对象包含(Integer、String、Date，其中Date为一个可变对象)，创建不可变对象后，更改入参的Date，并不会对不可变对象产生影响。故验证其为不可变对象类。</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-25%20%E4%B8%8B%E5%8D%883.14.00.png" alt=""></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="http://howtodoinjava.com/core-java/related-concepts/how-to-make-a-java-class-immutable/" target="_blank" rel="external">how-to-make-a-java-class-immutable</a></li>
<li><a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/imstrat.html" target="_blank" rel="external">Java官方文档-不可变类</a> </li>
<li>Java多线程编程实战指南(设计模式篇) - 黄文海 </li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/24/Java序列化/" itemprop="url">
                  Java序列化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-24T22:46:34+08:00" content="2016-09-24">
              2016-09-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/24/Java序列化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/24/Java序列化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="序列化是什么？"><a href="#序列化是什么？" class="headerlink" title="序列化是什么？"></a>序列化是什么？</h3><p>序列化是一种用来处理对象流的机制，所谓对象流就是将对象的内容进行流化，可以对流化后的对象进行读写操作，也可以将流化后的对象传输于网络之间。</p>
<p><code>序列化</code>：将数据分解成字节流，以便存储在文件中或在网络上传输。</p>
<p><code>反序列化</code>：打开字节流并重构对象。对象序列化不仅要将基本数据类型转换成字节表示，还有恢复数据的对象实例。</p>
<h3 id="序列化使用场景"><a href="#序列化使用场景" class="headerlink" title="序列化使用场景"></a>序列化使用场景</h3><ul>
<li>对象序列化可以实现分布式对象，如RMI要利用对象序列化运行远程主机上的服务，就像在本地机上运行对象一样。</li>
<li><code>JAVA</code>对象序列化不仅保留一个对象的数据，而且递归保存对象引用的每个对象的数据。可以将整个对象层次写入字节流中，可以保存在文件中或网络连接上传递。利用对象序列化可以进行对象的深复制，即复制对象本身及引用的对象本身。序列化一个对象可能得到整个对象序列。</li>
</ul>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong> Employee序列化</strong></p>
<p><code>serialVersionUID序列化ID</code> ：序列化ID不同，对象是无法相互序列化和反序列化的。</p>
<p><code>transient</code> ： 在变量声明前加上该关键字，可以阻止该变量被序列化到文件中，在被反序列化后，transient 变量的值被设为初始值，如 int 型的是 0，对象型的是 null。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class Employee implements Serializable &#123;</div><div class="line">    private static final long serialVersionUID = -5310833892778578686L;</div><div class="line">    private String name;</div><div class="line">    private String address;</div><div class="line">    private transient Integer SSN;</div><div class="line">    private Integer number;</div><div class="line">	</div><div class="line">	// 此处省略Getter &amp; Setter 方法</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>将序列化对象赋值后存入文件中</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class SerializeDemo &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Employee e = new Employee();</div><div class="line">        e.setAddress(&quot;上海&quot;);</div><div class="line">        e.setName(&quot;张三&quot;);</div><div class="line">        e.setSSN(123);</div><div class="line">        e.setNumber(123);</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            FileOutputStream fileOut = new FileOutputStream(&quot;/tmp/employee.ser&quot;);</div><div class="line">            ObjectOutputStream out = new ObjectOutputStream(fileOut);</div><div class="line">            out.writeObject(e);</div><div class="line">            out.close();</div><div class="line">            fileOut.close();</div><div class="line">            System.out.printf(&quot;Serialized data is saved in /tmp/employee.ser&quot;);</div><div class="line">        &#125; catch (IOException i) &#123;</div><div class="line">            i.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>查看存入文件中的序列化对象</strong></p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-9-24/99793188.jpg" alt=""></p>
<p><strong>从文件中反序列化字节码为Employee对象</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class DeserializeDemo &#123;</div><div class="line"></div><div class="line">   public static void main(String [] args) &#123;</div><div class="line">      Employee e = null;</div><div class="line">      try &#123;</div><div class="line">         FileInputStream fileIn = new FileInputStream(&quot;/tmp/employee.ser&quot;);</div><div class="line">         ObjectInputStream in = new ObjectInputStream(fileIn);</div><div class="line">         e = (Employee) in.readObject();</div><div class="line">         in.close();</div><div class="line">         fileIn.close();</div><div class="line">      &#125;catch(IOException i) &#123;</div><div class="line">         i.printStackTrace();</div><div class="line">         return;</div><div class="line">      &#125;catch(ClassNotFoundException c) &#123;</div><div class="line">         System.out.println(&quot;Employee class not found&quot;);</div><div class="line">         c.printStackTrace();</div><div class="line">         return;</div><div class="line">      &#125;</div><div class="line">      System.out.println(&quot;Employee&quot; + JSON.toJSONString(e));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>反序列化结果</strong></p>
<p>被声明为<code>transient</code>的<code>SSN</code>属性没有序列化，故没有反序列化出来。</p>
<p><img src="http://oc5a5l0a0.bkt.clouddn.com/16-9-24/15700843.jpg" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>一个类进行序列化和反序列化其序列化ID必须一致，否则将出错。</li>
<li>子类实现序列化接口，父类未实现序列化接口，反序列化中，父类的属性与序列化不一致，解决办法，将父类也实现序列化接口。</li>
<li>对于对象中不需要序列化的属性前加<code>transient</code>关键字</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oc5a5l0a0.bkt.clouddn.com/16-10-7/31807945.jpg"
               alt="流云" />
          <p class="site-author-name" itemprop="name">流云</p>
          <p class="site-description motion-element" itemprop="description">每天进步一点</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">132</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">流云</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"jianwl"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

</body>
</html>
